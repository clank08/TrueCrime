version: '3.8'

services:
  # ============================================================================
  # PostgreSQL Database (Essential for local development)
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: truecrime-postgres-dev
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: truecrime
      POSTGRES_PASSWORD: truecrime
      POSTGRES_DB: truecrime_db
      POSTGRES_HOST_AUTH_METHOD: trust
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U truecrime -d truecrime_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # Redis Cache (Essential for sessions and caching)
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: truecrime-redis-dev
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_dev_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # Meilisearch (Optional for local development, useful for search testing)
  # ============================================================================
  meilisearch:
    image: getmeili/meilisearch:v1.6
    container_name: truecrime-meilisearch-dev
    ports:
      - "7700:7700"
    environment:
      MEILI_MASTER_KEY: masterKey_LOCAL_DEVELOPMENT_ONLY
      MEILI_ENV: development
      MEILI_LOG_LEVEL: INFO
      MEILI_NO_ANALYTICS: true
    volumes:
      - meilisearch_dev_data:/meili_data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    profiles:
      - search

  # ============================================================================
  # Database Management Tools (Optional - use with --profile tools)
  # ============================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: truecrime-pgadmin-dev
    ports:
      - "5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: dev@truecrime.local
      PGADMIN_DEFAULT_PASSWORD: dev123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    volumes:
      - pgadmin_dev_data:/var/lib/pgadmin
    depends_on:
      - postgres
    restart: unless-stopped
    profiles:
      - tools

  redis-insight:
    image: redislabs/redisinsight:latest
    container_name: truecrime-redis-insight-dev
    ports:
      - "8001:8001"
    volumes:
      - redis_insight_dev_data:/db
    restart: unless-stopped
    profiles:
      - tools

# ============================================================================
# Volumes
# ============================================================================
volumes:
  postgres_dev_data:
    name: truecrime-postgres-dev-data
  redis_dev_data:
    name: truecrime-redis-dev-data
  meilisearch_dev_data:
    name: truecrime-meilisearch-dev-data
  pgadmin_dev_data:
    name: truecrime-pgadmin-dev-data
  redis_insight_dev_data:
    name: truecrime-redis-insight-dev-data